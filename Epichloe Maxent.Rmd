---
title: 'SDM for Epichloe endophyte host species'
author: "Jacob Moutouama "
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup,cache=TRUE,include=FALSE}
library(knitr)
opts_chunk$set(external=TRUE,echo=F,warning=FALSE,fig.pos='H',autodep = TRUE, global.device = TRUE)
a4width<- 8.3
a4height<- 11.7
options(knitr.table.format = "latex")
```



```{r eval=FALSE,echo=T}
rm(list = ls())
```

```{r}
# Load packages
library("prism")
library("raster")
library("dismo")
library("usdm")
library("car")
library("FactoMineR")
library("factoextra")
library("corrplot")
library("ENMTools")
library("vip")
library("pdp")
library("fastshap")
library("CalibratR")
library("maptools")
library("rgeos")
library("leaflet")
library("tidyverse")
# install.extras()
library("geodata")
library("terra")
library("rgdal")
library("sp")
library("ENMeval")
library("mecofun")
library("mgcv")
library("randomForest")
library("spThin")
# if( !("rJava" %in% rownames(installed.packages()))  ){
#   install.packages("rJava",repos="http://cran.r-project.org")
# }

# if(Sys.info()["sysname"] != "Windows" ){
#   dyn.load('/Library/Java/JavaVirtualMachines/temurin-17.jdk/Contents/Home/lib/server/libjvm.dylib')
# }
library("rJava")
# if( !file.exists(paste0(system.file("java", package="dismo"),"/maxent.jar"))  )   {
# utils::download.file(url="https://raw.githubusercontent.com/mrmaxent/Maxent/master/ArchivedReleases/3.3.3k/maxent.jar",
#                      destfile=paste0(system.file("java", package="dismo"),"/maxent.jar"),
#                      mode="wb") ## wb for binary file, otherwise maxent.jar can not execute
# }

```

# Climatic data 
## Data from PRISM
```{r}
# making a folder to store prism data
prism_set_dl_dir("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Clim")

# getting monthly data for mean temp and precipitation
# takes a long time the first time, but can skip when you have raster files saved on your computer.
# get_prism_monthlys(type = "tmean", years = 1895:2020, mon = 1:12, keepZip = FALSE)
# get_prism_monthlys(type = "ppt", years = 1895:2020, mon = 1:12, keepZip = FALSE)
```


```{r}
# pulling out values to get normals for old and new time periods
tmean_annual_recent_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1990:2020))))
tmean_spring_recent_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1990:2020, mon = 1:4))))
tmean_summer_recent_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1990:2020, mon = 5:8))))
tmean_autumn_recent_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1990:2020, mon = 9:12))))


tmean_annual_old_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1895:1925))))
tmean_spring_old_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1895:1925, mon = 1:4))))
tmean_summer_old_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1895:1925, mon = 5:8))))
tmean_autumn_old_norm <- terra::mean(terra::rast(pd_stack(prism_archive_subset(type = "tmean", temp_period = "monthly", year = 1895:1925, mon = 9:12))))

```


```{r}
# calculating the cumulative precipitation for each year and for each season within the year
ppt_annual_recent <- ppt_spring_recent <- ppt_summer_recent <- ppt_autumn_recent <- ppt_winter_recent<- list()
for(y in 1990:2020){
ppt_annual_recent[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y))))
ppt_spring_recent[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 1:4))))
ppt_summer_recent[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 5:8))))
ppt_autumn_recent[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 9:12)))) 
}

ppt_annual_old <- ppt_spring_old <- ppt_summer_old <- ppt_autumn_old <- ppt_winter_old<- list()
for(y in 1895:1925){
  ppt_annual_old[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y))))
  ppt_spring_old[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 1:4))))
  ppt_summer_old[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 5:8))))
  ppt_autumn_old[[y]] <- sum(terra::rast(pd_stack(prism_archive_subset(type = "ppt", temp_period = "monthly", year = y, mon = 9:12)))) # including December here because the year needs to wrap around...
}

# Taking the mean of the cumulative precipation values
ppt_annual_recent_norm <- terra::mean(terra::rast(unlist(ppt_annual_recent)))
ppt_spring_recent_norm <- terra::mean(terra::rast(unlist(ppt_spring_recent)))
ppt_summer_recent_norm <- terra::mean(terra::rast(unlist(ppt_summer_recent)))
ppt_autumn_recent_norm <- terra::mean(terra::rast(unlist(ppt_autumn_recent)))

ppt_annual_old_norm <- terra::mean(terra::rast(unlist(ppt_annual_old)))
ppt_spring_old_norm <- terra::mean(terra::rast(unlist(ppt_spring_old)))
ppt_summer_old_norm <- terra::mean(terra::rast(unlist(ppt_summer_old)))
ppt_autumn_old_norm <- terra::mean(terra::rast(unlist(ppt_autumn_old)))
```

## Variance inflation factor (VIF)  to have  a measure of multicollinearity among the  variables
```{r}
US_worldclim_recent_norm<-terra::rast(list(tmean_spring_recent_norm,tmean_summer_recent_norm,tmean_autumn_recent_norm,ppt_spring_recent_norm,ppt_summer_recent_norm,ppt_autumn_recent_norm))
US_worldclim_recent_norm_stack<-stack(US_worldclim_recent_norm)
# plot(US_worldclim_recent_norm_stack)
```

## Variance inflation factor (VIF)  to have  a measure of multicollinearity among the  variables

$$
VIF =(\frac{1}{1-R^{2}})
$$
```{r}
# (var_vif<-usdm::vifstep(US_worldclim_recent_norm_stack, th=10))
(vif <- vifcor(US_worldclim_recent_norm_stack, th=0.7))

```

## Saved the rasters 
### Recent
```{r}
writeRaster(tmean_spring_recent_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/recent/tmean_spring_recent_norm.tif')
writeRaster(ppt_spring_recent_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/recent/ppt_spring_recent_norm.tif')
writeRaster(ppt_summer_recent_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/recent/ppt_summer_recent_norm.tif')
```
### old 
```{r}
writeRaster(tmean_spring_old_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/old/tmean_spring_old_norm.tif')
writeRaster(ppt_spring_old_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/old/ppt_spring_old_norm.tif')
writeRaster(ppt_summer_old_norm, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Final variable/old/ppt_summer_old_norm.tif')
```

## Final climatic variables to use for the SDM 

```{r}
US_worldclim_recent_norm_stack_vif<-terra::rast(list(tmean_spring_recent_norm,ppt_spring_recent_norm,ppt_summer_recent_norm))
names(US_worldclim_recent_norm_stack_vif) <- c("tmean_spring", "ppt_spring","ppt_summer")
US_worldclim_recent_norm_stack_final<-stack(US_worldclim_recent_norm_stack_vif)

US_worldclim_old_norm_stack_vif<-terra::rast(list(tmean_spring_old_norm,ppt_spring_old_norm,ppt_summer_old_norm))
names(US_worldclim_old_norm_stack_vif) <- c("tmean_spring", "ppt_spring","ppt_summer")
US_worldclim_old_norm_stack_final<-stack(US_worldclim_old_norm_stack_vif)

```

```{r}
plot(US_worldclim_recent_norm_stack_final)
```

```{r}
plot(US_worldclim_old_norm_stack_final)
```


# *Agrostis hyemalis*
## Import occurence data from Josh database and merge them later to existing online data

```{r}
endo_herb_georef<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/endo_herb_georef.csv", header=T)
```

## Download occurrence data from gbif for *Agrostis hyemalis*

```{r} 
# dir.create("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence")
# aghy_occ_raw <- gbif(genus="Agrostis",species="hyemalis",download=TRUE) 
load("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/aghy_occ_raw.rdata")
head(aghy_occ_raw) # to view the first few records the occurrence dataset use
```

## Clean occurrence data from gbif

```{r}
aghy_occ <- subset(aghy_occ_raw,(!is.na(lat))&(!is.na(lon))) # here we remove erroneous coordinates, where either the latitude or longitude is missing
cat(nrow(aghy_occ_raw)-nrow(aghy_occ), "records are removed") # Show the number of records that are removed from the dataset. 
aghy_occ %>% 
  dplyr::select(country,lon, lat, year,basisOfRecord)%>% 
  filter(country=="United States")->aghy_occ_clean # We want only occurrence data for the US

```

```{r}
dups_aghy <- duplicated(aghy_occ_clean[c("lat","lon")]  )
aghy_occ_unique <- aghy_occ_clean[!dups_aghy,] # Remove duplicated data based on latitude and longitude
cat(nrow(aghy_occ_clean)-nrow(aghy_occ_unique), "records are removed")
```

```{r}
table(aghy_occ_unique$basisOfRecord) # show the frequency table of “basisOfRecord”
```

```{r}
hist(aghy_occ_unique$year,main="",xlim=c(1895,2020),ylim=c(0,500),col="orange2",xlab="years")
```

```{r}
aghy_occ_unique %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1990:2020) & as.numeric(lon >=-126.374160))->aghy_occ_1990_2020 #  filter from 1990 to 2020 to match climatic data.

aghy_occ_unique  %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1895:1925) & as.numeric(lon >=-126.374160))->aghy_occ_1895_1925 #  filter from 1895 to 1925 to match climatic data.
 
summary(aghy_occ_1990_2020$year) # show a quick summary of years in the data
summary(aghy_occ_1895_1925$year) # show a quick summary of years in the data
```

## Merge data from Josh database to GBIF  data

```{r}
endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="AGHY" & year %in% (1990:2020))->aghy_occgeoref_1990_2020 

endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="AGHY" & year %in% (1895:1925))->aghy_occgeoref_1895_1925

aghy_occ_final_1990_2020<-rbind(aghy_occ_1990_2020[,-3],aghy_occgeoref_1990_2020[,-c(3,4)])
aghy_occ_final_1895_1925<-rbind(aghy_occ_1895_1925[,-3],aghy_occgeoref_1895_1925[,-c(3,4)])
dupfinal1990_2020 <- duplicated(aghy_occ_final_1990_2020[,c(1,2)])
dupfinal1895_1925 <- duplicated(aghy_occ_final_1895_1925[,c(1,2)])


aghy_occ_unique_final_1990_2020 <- aghy_occ_final_1990_2020[!dupfinal1990_2020,]
aghy_occ_unique_final_1895_1925<-aghy_occ_final_1895_1925[!dupfinal1895_1925,]

```

## Spatial thinning of species occurence records

```{r,eval=FALSE}
ID<-rep("AGHY",nrow(aghy_occ_unique_final_1990_2020))
aghy_sdm_final_1990_2020<-data.frame(ID,aghy_occ_unique_final_1990_2020)
names(aghy_sdm_final_1990_2020)<-c("ID","Long","Lat")
thinned.aghy_recent <- spThin::thin(aghy_sdm_final_1990_2020,lat.col = "Lat",long.col = "Long",spec.col = "ID",
                         thin.par=9, reps=10, locs.thinned.list.return = FALSE,
                         write.files = TRUE, max.files = 5, out.dir="/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence", 
                         out.base = "points_aghy_thinned_recent", write.log.file = TRUE,
                         log.file = "spatial_thin_aghy_recent_log.txt", verbose = TRUE)

```

```{r}
aghy_thinned_recent<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/aghy_thinned_recent.csv", header=T)
aghy_thinned<-aghy_thinned_recent[,-1]
```

## Projection on a map to double check if there is any point out of the US

```{r}
library(maptools)
data(wrld_simpl)
plot(US_worldclim_recent_norm_stack_final,1)
plot(wrld_simpl, add=TRUE)
points(aghy_thinned, col='#0072B2',pch=19)
```

## Maxent model for *Agrostis hyemalis*

```{r}
set.seed(13)
group_pres_aghy <- kfold(aghy_thinned, 5)
pres_train_aghy <- aghy_thinned[group_pres_aghy != 1, ] # training data 
pres_test_aghy <- aghy_thinned[group_pres_aghy == 1, ] # testing data
```

```{r}
set.seed(13)
backg_aghy <- randomPoints(US_worldclim_recent_norm_stack_final, n=10000)
colnames(backg_aghy) = c('Long', 'Lat')
group_backg_aghy <- kfold(backg_aghy, 5)
backg_train_aghy <- backg_aghy[group_backg_aghy != 1, ]
backg_test_aghy <- backg_aghy[group_backg_aghy == 1, ]
```

```{r}
r <- raster(US_worldclim_recent_norm_stack_final, 1)
plot(!is.na(r), col=c('white', 'light grey'), legend=FALSE)
points(backg_train_aghy, pch='-', cex=0.5, col='#F0E442')
points(backg_test_aghy, pch='-',  cex=0.5, col='#000000')
points(pres_train_aghy, pch= '+', col='#009E73')
points(pres_test_aghy, pch='+', col='#0072B2')
```

```{r}
mod_aghy <- maxent(US_worldclim_recent_norm_stack_final, pres_train_aghy)
# plot(mod_aghy)
```
## Save the model output 
```{r}
e_aghy <- evaluate(pres_test_aghy, backg_test_aghy, mod_aghy, US_worldclim_recent_norm_stack_final)
map_recent_aghy <- predict(US_worldclim_recent_norm_stack_final, mod_aghy,  progress='')
map_old_aghy <- predict(US_worldclim_old_norm_stack_final, mod_aghy,  progress='')
writeRaster(map_recent_aghy, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_aghy.tif')
writeRaster(map_old_aghy, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_aghy.tif')
```

```{r}
par(mfrow=c(2,2))
plot(map_recent_aghy, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
plot(map_old_aghy, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')
```


```{r}
tr_aghy <- threshold(e_aghy, 'spec_sens')
plot(map_recent_aghy > tr_aghy, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')

plot(map_old_aghy > tr_aghy, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')
dev.off()
```

```{r}
map_recent_aghy_presence_absence<- (map_recent_aghy > tr_aghy)
writeRaster(map_recent_aghy_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_aghy_presence_absence.tif')
map_old_aghy_presence_absence<- (map_old_aghy > tr_aghy)
writeRaster(map_old_aghy_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_aghy_presence_absence.tif')
```


## Download occurrence data from gbif for *Agrostis perennans*

```{r} 
# agpe_occ_raw <- gbif(genus="Agrostis",species="perennans",download=TRUE) 
load("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/agpe_occ_raw.rdata")
head(agpe_occ_raw ) # to view the first few records the occurrence dataset use:
```

## Clean occurrence data from gbif

```{r}
agpe_occ <- subset(agpe_occ_raw,(!is.na(lat))&(!is.na(lon))) # here we remove erroneous coordinates, where either the latitude or longitude is missing
cat(nrow(agpe_occ_raw)-nrow(agpe_occ), "records are removed") #Show the number of records that are removed from the dataset. 
agpe_occ %>% 
  dplyr::select(country,lon, lat, year,basisOfRecord)%>% 
  filter(country=="United States")->agpe_occ_clean

```

```{r}
dups_agpe <- duplicated(agpe_occ_clean[c("lat","lon")]  )
agpe_occ_unique <- agpe_occ_clean[!dups_agpe,] # Remove duplicated data based on latitude and longitude
cat(nrow(agpe_occ_clean)-nrow(agpe_occ_unique), "records are removed")
```

```{r}
table(agpe_occ_unique$basisOfRecord) # show the frequency table of “basisOfRecord”
```

```{r}
hist(agpe_occ_unique$year,main="",xlim=c(1895,2020),ylim=c(0,500),col="orange2",xlab="years")
```

```{r}
agpe_occ_unique %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1990:2020) & as.numeric(lon >=-126.374160))->agpe_occ_1990_2020 #  filter from 1990 to 2020 to match climatic data.

agpe_occ_unique  %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1895:1925) & as.numeric(lon >=-126.374160))->agpe_occ_1895_1925
 
summary(agpe_occ_1990_2020$year) # show a quick summary of years in the data
summary(agpe_occ_1895_1925$year) # show a quick summary of years in the data

```

## Merge endophyte host data from Josh database to GBIF  data

```{r}
endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="AGPE" & year %in% (1990:2020))->agpe_occgeoref_1990_2020 

endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="AGPE" & year %in% (1895:1925))->agpe_occgeoref_1895_1925

agpe_occ_final_1990_2020<-rbind(agpe_occ_1990_2020[,-3],agpe_occgeoref_1990_2020[,-c(3,4)])
agpe_occ_final_1895_1925<-rbind(agpe_occ_1895_1925[,-3],agpe_occgeoref_1895_1925[,-c(3,4)])
dupfinal1990_2020 <- duplicated(agpe_occ_final_1990_2020[,c(1,2)])
dupfinal1895_1925 <- duplicated(agpe_occ_final_1895_1925[,c(1,2)])


agpe_occ_unique_final_1990_2020 <- agpe_occ_final_1990_2020[!dupfinal1990_2020,]
agpe_occ_unique_final_1895_1925<-agpe_occ_final_1895_1925[!dupfinal1895_1925,]

```

## Spatial thinning of species occurence records

```{r,eval=FALSE}
ID<-rep("AGPE",nrow(agpe_occ_unique_final_1990_2020))
agpe_sdm_final_1990_2020<-data.frame(ID,agpe_occ_unique_final_1990_2020)
names(agpe_sdm_final_1990_2020)<-c("ID","Long","Lat")
thinned.agpe_recent <- spThin::thin(agpe_sdm_final_1990_2020,lat.col = "Lat",long.col = "Long",spec.col = "ID",
                         thin.par=9, reps=10, locs.thinned.list.return = FALSE,
                         write.files = TRUE, max.files = 5, out.dir="/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence", 
                         out.base = "points_agpe_thinned_recent", write.log.file = TRUE,
                         log.file = "spatial_thin_agpe_recent_log.txt", verbose = TRUE)

```

```{r}
agpe_thinned_recent<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/agpe_thinned_recent.csv", header=T)
agpe_thinned<-agpe_thinned_recent[,-1]
```

## Projection on a map to double check if there is any point of the US

```{r}
library(maptools)
data(wrld_simpl)
plot(US_worldclim_recent_norm_stack_final,1)
plot(wrld_simpl, add=TRUE)
points(agpe_thinned, col='#0072B2',pch=19)
```

## Maxent model for *Agrostis perennans*

```{r}
set.seed(13)
group_pres_agpe <- kfold(agpe_thinned, 5)
pres_train_agpe <- agpe_thinned[group_pres_agpe != 1, ] # training data 
pres_test_agpe <- agpe_thinned[group_pres_agpe == 1, ] # testing data
```

```{r}
set.seed(13)
backg_agpe <- randomPoints(US_worldclim_recent_norm_stack_final, n=10000)
colnames(backg_agpe) = c('Long', 'Lat')
group_backg_agpe <- kfold(backg_agpe, 5)
backg_train_agpe <- backg_agpe[group_backg_agpe != 1, ]
backg_test_agpe <- backg_agpe[group_backg_agpe == 1, ]
```

```{r}
r <- raster(US_worldclim_recent_norm_stack_final, 1)
plot(!is.na(r), col=c('white', 'light grey'), legend=FALSE)
points(backg_train_agpe, pch='-', cex=0.5, col='#F0E442')
points(backg_test_agpe, pch='-',  cex=0.5, col='#000000')
points(pres_train_agpe, pch= '+', col='#009E73')
points(pres_test_agpe, pch='+', col='#0072B2')
```

```{r}
mod_agpe <- maxent(US_worldclim_recent_norm_stack_final, pres_train_agpe)
# plot(mod_aghy)
```

```{r}
e_agpe <- evaluate(pres_test_agpe, backg_test_agpe, mod_agpe, US_worldclim_recent_norm_stack_final)
map_recent_agpe <- predict(US_worldclim_recent_norm_stack_final, mod_agpe,  progress='')
map_old_agpe <- predict(US_worldclim_old_norm_stack_final, mod_agpe,  progress='')
writeRaster(map_recent_agpe, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_agpe.tif')
writeRaster(map_old_agpe, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_agpe.tif')

```



```{r}
par(mfrow=c(2,2))
plot(map_recent_agpe, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
plot(map_old_agpe, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')

```

```{r}
tr_agpe <- threshold(e_agpe, 'spec_sens')
plot(map_recent_agpe > tr_agpe, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')

plot(map_old_agpe > tr_agpe, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')
dev.off()
```


```{r}
map_recent_agpe_presence_absence<- (map_recent_agpe > tr_agpe)
writeRaster(map_recent_agpe_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_agpe_presence_absence.tif')

map_old_agpe_presence_absence<- (map_old_agpe > tr_agpe)
writeRaster(map_old_agpe_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_agpe_presence_absence.tif')
```

## Download occurrence data from gbif for *Elymus virginicus*

```{r} 
# elvi_occ_raw <- gbif(genus="Elymus",species="virginicus",download=TRUE) 
load("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/elvi_occ_raw.rdata")
head(elvi_occ_raw)
```

## Clean occurrence data from gbif

```{r}
elvi_occ <- subset(elvi_occ_raw,(!is.na(lat))&(!is.na(lon))) # here we remove erroneous coordinates, where either the latitude or longitude is missing
cat(nrow(elvi_occ_raw)-nrow(elvi_occ), "records are removed") #Show the number of records that are removed from the dataset. 
elvi_occ %>% 
  dplyr::select(country,lon, lat, year,basisOfRecord)%>% 
  filter(country=="United States")->elvi_occ_clean

```

```{r}
dups_elvi <- duplicated(elvi_occ_clean[c("lat","lon")]  )
elvi_occ_unique <- elvi_occ_clean[!dups_elvi,] # Remove duplicated data based on latitude and longitude
cat(nrow(elvi_occ_clean)-nrow(elvi_occ_unique), "records are removed")
```

```{r}
table(elvi_occ_unique$basisOfRecord) # show the frequency table of “basisOfRecord”
```

```{r}
hist(elvi_occ_unique$year,main="",xlim=c(1895,2020),ylim=c(0,2000),col="orange2",xlab="years")
```

```{r}
elvi_occ_unique %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1990:2020) & as.numeric(lon >=-126.374160))->elvi_occ_1990_2020 #  filter from 1990 to 2020 to match climatic data.

elvi_occ_unique  %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1895:1925) & as.numeric(lon >=-126.374160))->elvi_occ_1895_1925
 
summary(elvi_occ_1990_2020$year) # show a quick summary of years in the data
summary(elvi_occ_1895_1925$year) # show a quick summary of years in the data

```

## Import endophyte host data from Josh database and merge them to existing online data

```{r}
endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="ELVI" & year %in% (1990:2020))->elvi_occgeoref_1990_2020 

endo_herb_georef %>% 
  dplyr::select(lon, lat, year,Spp_code)%>% 
  filter(Spp_code=="ELVI" & year %in% (1895:1925))->elvi_occgeoref_1895_1925

elvi_occ_final_1990_2020<-rbind(elvi_occ_1990_2020[,-3],elvi_occgeoref_1990_2020[,-c(3,4)])
elvi_occ_final_1895_1925<-rbind(elvi_occ_1895_1925[,-3],elvi_occgeoref_1895_1925[,-c(3,4)])
dupfinal1990_2020 <- duplicated(elvi_occ_final_1990_2020[,c(1,2)])
dupfinal1895_1925 <- duplicated(elvi_occ_final_1895_1925[,c(1,2)])


elvi_occ_unique_final_1990_2020 <- elvi_occ_final_1990_2020[!dupfinal1990_2020,]
elvi_occ_unique_final_1895_1925<-elvi_occ_final_1895_1925[!dupfinal1895_1925,]

```

## Spatial thinning of species occurence records

```{r,eval=FALSE}
ID<-rep("ELVI",nrow(elvi_occ_unique_final_1990_2020))
elvi_sdm_final_1990_2020<-data.frame(ID,elvi_occ_unique_final_1990_2020)
names(elvi_sdm_final_1990_2020)<-c("ID","Long","Lat")
thinned.elvi_recent <- spThin::thin(elvi_sdm_final_1990_2020,lat.col = "Lat",long.col = "Long",spec.col = "ID",
                         thin.par=9, reps=10, locs.thinned.list.return = FALSE,
                         write.files = TRUE, max.files = 5, out.dir="/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence", 
                         out.base = "points_elvi_thinned_recent", write.log.file = TRUE,
                         log.file = "spatial_thin_elvi_recent_log.txt", verbose = TRUE)

```

```{r}
elvi_thinned_recent<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/elvi_thinned_recent.csv", header=T)
elvi_thinned<-elvi_thinned_recent[,-1]
```

## Projection on a map to double check if there is any point of the US


```{r}
library(maptools)
data(wrld_simpl)
plot(US_worldclim_recent_norm_stack_final,1)
plot(wrld_simpl, add=TRUE)
points(elvi_thinned, col='#0072B2',pch=19)
```

## Maxent model for *Elymus virginicus*

```{r}
set.seed(13)
group_pres_elvi <- kfold(elvi_thinned, 5)
pres_train_elvi <- elvi_thinned[group_pres_elvi != 1, ] # training data 
pres_test_elvi <- elvi_thinned[group_pres_elvi == 1, ] # testing data
```

```{r}
set.seed(13)
backg_elvi <- randomPoints(US_worldclim_recent_norm_stack_final, n=10000)
colnames(backg_elvi) = c('Long', 'Lat')
group_backg_elvi <- kfold(backg_elvi, 5)
backg_train_elvi <- backg_elvi[group_backg_elvi != 1, ]
backg_test_elvi <- backg_elvi[group_backg_elvi == 1, ]
```

```{r}
r <- raster(US_worldclim_recent_norm_stack_final, 1)
plot(!is.na(r), col=c('white', 'light grey'), legend=FALSE)
points(backg_train_elvi, pch='-', cex=0.5, col='#F0E442')
points(backg_test_elvi, pch='-',  cex=0.5, col='#000000')
points(pres_train_elvi, pch= '+', col='#009E73')
points(pres_test_elvi, pch='+', col='#0072B2')
```

```{r}
mod_elvi <- maxent(US_worldclim_recent_norm_stack_final, pres_train_elvi)
# plot(mod_aghy)
```

```{r}
e_elvi <- evaluate(pres_test_elvi, backg_test_elvi, mod_elvi, US_worldclim_recent_norm_stack_final)
map_recent_elvi <- predict(US_worldclim_recent_norm_stack_final, mod_elvi,  progress='')
map_old_elvi <- predict(US_worldclim_old_norm_stack_final, mod_elvi,  progress='')
writeRaster(map_recent_elvi, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_elvi.tif')
writeRaster(map_old_elvi, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_elvi.tif')
```


```{r}
par(mfrow=c(2,2))
plot(map_recent_elvi, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
plot(map_old_elvi, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')
```

```{r}
tr_elvi <- threshold(e_elvi, 'spec_sens')
plot(map_recent_elvi > tr_elvi, main='2020')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')

plot(map_old_elvi > tr_elvi, main='1925')
plot(wrld_simpl, add=TRUE, border='dark grey')
# points(pres_train_aghy, pch='+')
```


```{r}
map_recent_elvi_presence_absence<- (map_recent_elvi > tr_elvi)
writeRaster(map_recent_elvi_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_recent_elvi_presence_absence.tif')

map_old_elvi_presence_absence<- (map_old_elvi > tr_elvi)
writeRaster(map_old_elvi_presence_absence, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Model/raster_old_elvi_presence_absence.tif')
```



```{r}
# layout.matrix <- matrix(c(1, 2, 3, 4,5,6), nrow = 2, ncol = 3)
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/EndoHerbarium/Manuscript/FigSDMMaxent.pdf",height = 5,width = 10)
# layout(mat = layout.matrix)
op<-par(mfrow = c(2,3), mar=c(3,3,2,1),oma = c(5, 5, 1, 3))
plot(map_old_aghy,xaxt='n',main=substitute(paste(italic("A. hyemalis"))))
text(x=-100,y=50,label="1925")
# par(mar=c(2.2,1,3,1))
plot(map_old_agpe,xaxt='n',yaxt='n', main=substitute(paste(italic("A. perennans"))))
text(x=-100,y=50,label="1925")
# par(mar=c(2.2,1,3,1))
plot(map_old_elvi, xaxt='n',yaxt='n',main=substitute(paste(italic("E. virginicus"))))
text(x=-100,y=50,label="1925")
# par(mar=c(5,3,0,1))
plot(map_recent_aghy, main="")
text(x=-100,y=50,label="2020")
# par(mar=c(5,1,0,1))
plot(map_recent_agpe,yaxt='n', main="")
text(x=-100,y=50,label="2020")
# par(mar=c(5,1,0,1))
plot(map_recent_elvi,yaxt='n', main="")
text(x=-100,y=50,label="2020")
title(xlab="Longitude", ylab="Latitude", outer=T, cex.lab=1.2,line = 1.5)

par(op)
dev.off()

```

```{r}
# layout.matrix <- matrix(c(1, 2, 3, 4,5,6), nrow = 2, ncol = 3)
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/EndoHerbarium/Manuscript/FigSDMMaxent_Presence_absence.pdf",height = 5,width = 10)
# layout(mat = layout.matrix)
op<-par(mfrow = c(2,3), mar=c(3,3,2,1),oma = c(5, 5, 1, 3))
plot(map_old_aghy > tr_aghy,xaxt='n',main=substitute(paste(italic("A. hyemalis"))))
text(x=-100,y=50,label="1925")
# par(mar=c(2.2,1,3,1))
plot(map_old_agpe > tr_agpe,xaxt='n',yaxt='n', main=substitute(paste(italic("A. perennans"))))
text(x=-100,y=50,label="1925")
# par(mar=c(2.2,1,3,1))
plot(map_old_elvi > tr_elvi, xaxt='n',yaxt='n',main=substitute(paste(italic("E. virginicus"))))
text(x=-100,y=50,label="1925")
# par(mar=c(5,3,0,1))
plot(map_recent_aghy > tr_aghy, main="")
text(x=-100,y=50,label="2020")
# par(mar=c(5,1,0,1))
plot(map_recent_agpe > tr_agpe,yaxt='n', main="")
text(x=-100,y=50,label="2020")
# par(mar=c(5,1,0,1))
plot(map_recent_elvi > tr_elvi,yaxt='n', main="")
text(x=-100,y=50,label="2020")
title(xlab="Longitude", ylab="Latitude", outer=T, cex.lab=1.2,line = 1.5)

par(op)
dev.off()

```



```


